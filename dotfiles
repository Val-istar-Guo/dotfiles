#!/usr/bin/env bash
set -euo pipefail

#======================================================================
# Dotfiles CLI 工具
# 用途：提供便捷的 dotfiles 管理命令
#======================================================================

# 加载公共变量
# 如果脚本是符号链接，需要解析到真实路径
if [[ -L "${BASH_SOURCE[0]}" ]]; then
  SCRIPT_PATH="$(readlink "${BASH_SOURCE[0]}")"
else
  SCRIPT_PATH="${BASH_SOURCE[0]}"
fi
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
source "$SCRIPT_DIR/lib/common.sh"

# 更新配置
cmd_upgrade() {
  if [[ -f "$DOTFILES_DIR/upgrade.sh" ]]; then
    exec "$DOTFILES_DIR/upgrade.sh"
  else
    echo "[✗] 未找到更新脚本: $DOTFILES_DIR/upgrade.sh"
    exit 1
  fi
}

# 重新安装
cmd_install() {
  if [[ -f "$DOTFILES_DIR/bootstrap.sh" ]]; then
    cd "$DOTFILES_DIR"
    exec "./bootstrap.sh"
  else
    echo "[✗] 未找到安装脚本: $DOTFILES_DIR/bootstrap.sh"
    exit 1
  fi
}

# 显示帮助信息
cmd_help() {
  echo "用法: dotfiles <command>"
  echo
  echo "命令:"
  echo "  upgrade    更新配置"
  echo "  install    重新安装配置"
  echo "  help       显示帮助信息"
}

# 主函数
main() {
  local command="${1:-}"

  # 无参数时显示帮助
  if [[ -z "$command" ]]; then
    cmd_help
    exit 0
  fi

  case "$command" in
    upgrade)
      cmd_upgrade
      ;;
    install)
      cmd_install
      ;;
    help|--help|-h)
      cmd_help
      ;;
    *)
      echo "[✗] 未知命令: $command"
      echo
      cmd_help
      exit 1
      ;;
  esac
}

main "$@"
